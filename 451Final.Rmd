---
title: "451Project"
author: "Ling Ma, Debbie Sun"
date: "10/8/2020"
output: html_document
---
# Data Preprocessing
```{r,message=FALSE}
# Loading
library(dplyr)
library(naniar)
library(pcalg)
library(ggplot2)
library(dagitty)
library("splines")
```
+ `country`: recipient country
+ `year`: year
+ `US_ODA`: U.S. Official development assistance(treatment), defined as government aid designed to promote the economic development and welfare of developing countries[1]. 
+ `US_OOF`: U.S. Other Official Flows, transactions by the official sector with countries on the List of Aid Recipients which do not meet the conditions for eligibility as Official Development Assistance or Official Aid. 
+ `US_aid_total`: U.S. total aid the recipient received.
+ `Rest_of_world_ODA`: ODA except for U.S. and China(data of China is largely missing) the recipient received.
+ `Rest_of_world_OOF`: OOF except for U.S. and China(data of China is largely missing) the recipient received.
+ `Rest_of_world_aid_total`: rest of world total recipient received.
+ `polity2`:Recipient Polity Score,  "-10 (hereditary monarchy) to +10 (consolidated democracy)"
+ `oda_gni`: ODA in percentage in gross national income of the recipient's.
+ `population`:the total population of the recipient in that year.
+ `recipient_trade_world`:Recipient Total Trade with World
+ `GDP_per_growth_rate`: Recipient's GDP Per Capita growth rate, calculated by (this year - previous year)/previous year.
+ `GDP_total_growth_rate`: Recipient's total GDP growth rate, calculated by (this year - previous year)/previous year.
+ `population_growth_rate`: Recipient's Population growth rate, calculated by (this year - previous year)/previous year.


```{r pressure, echo=FALSE}
aid = read.csv("processed.csv")
aid$GDP_total_growth_rate = as.double(aid$GDP_total_growth_rate)
head(aid)
```
First, let's visualize the distribution of the missing data.
```{r}
vis_miss(aid)
vis_miss(aid,cluster = TRUE)
```
we decide to drop the observations that have missing values for the following reason:
1. "MNAR: Missing Not at Random - the missing is not random, it correlates with unobservable characteristics unknown to a researcher." The missing rows gather around the last 400 rows, so we cannot assume the missing is at random. 
2. we can afford to drop 7.7% of the original data as we still have 92.3% data left.

To get away with the time correlated concern, we decide to base our analysis on 2007 and 2012 because they have the least missing data. We conduct analysis on one of them, and use the result of the other one  to compare, which serves as a part of sensitive analysis to test the robustness of the former.

```{r}
aid = aid %>%
  na.omit(aid)

aid2007 = aid %>%
  filter(year==2007)

aid2012 = aid %>%
  filter(year==2012)
```

![](causal_graph.png)


# Causal Discovery


```{r echo=FALSE}
dag <- dagitty("
dag {
bb=\"0,0,1,1\"
\"A:US_ODA\" [exposure,pos=\"0.272,0.239\"]
\"Y:Recipient_GDP_growth_rate\" [outcome,pos=\"0.672,0.254\"]
national_demand [latent,pos=\"0.540,0.050\"]
oda_gni [pos=\"0.446,0.310\"]
polity2 [pos=\"0.357,0.039\"]
population_growth_rate [pos=\"0.651,0.028\"]
recipient_trade_world [pos=\"0.412,0.504\"]
rest_world_aid [pos=\"0.397,0.159\"]
\"A:US_ODA\" -> \"Y:Recipient_GDP_growth_rate\"
\"A:US_ODA\" -> oda_gni
national_demand -> \"Y:Recipient_GDP_growth_rate\"
national_demand -> oda_gni
national_demand -> recipient_trade_world
oda_gni -> \"Y:Recipient_GDP_growth_rate\"
polity2 -> \"A:US_ODA\"
polity2 -> \"Y:Recipient_GDP_growth_rate\"
polity2 -> national_demand
polity2 -> rest_world_aid
population_growth_rate -> \"Y:Recipient_GDP_growth_rate\"
population_growth_rate -> national_demand
recipient_trade_world -> \"A:US_ODA\"
recipient_trade_world -> \"Y:Recipient_GDP_growth_rate\"
recipient_trade_world -> rest_world_aid
rest_world_aid -> \"Y:Recipient_GDP_growth_rate\"
rest_world_aid -> oda_gni
}
")
plot(dag)
```
The causal graph is constructed based on our prior assumptions and common sense:

1. The outcome(Y: GDP growth rate of the recipient) depends on the national demand, population growth rate, the foreign aid received, potentially its autocracy-democracy index(polity2), and the recipient’s openness (measured by its global trade).

2. We assume that our treatment, US ODA, affect the outcome via direct effect(the recipient receives the aid) and indirect effect of ODA_GNI. The idea for GNI is that given the same amount of foreign aid, if the aid amounts to a large portion of the recipient’s gross national income, this aid should have a larger impact on the recipient. A similar idea applies to the foreign aid provided by the rest of the world.

3. We assume the recipient country’s openness to global trading contributes to not only GDP growth but also the amount of aid it’s going to receive. The rationale behind the assumption is the potential economic welfare gains from an aid could strongly motivate the donor. For example, the donor might want to have an impact on, or take a share of, the recipient’s market. Finally, we think it’s reasonable to assume that national demand affects the recipient’s global trade.

4. The assumption we made polity2 a confounder that has an impact on a wide range of other variables. The rationale behind this assumption is that the donors might also be motivated by enlarging their political impact on the recipient, such as winning over political support. 


### alpha = 0.01

```{r}
causalAid = aid2012 %>%
  dplyr::select(-X,-country,-year)
suff_stat <- list(C = cor(causalAid), n = nrow(causalAid))
pc_aid <- pc(suff_stat, indepTest = gaussCItest, labels = colnames(causalAid), alpha = 0.01, skel.method = "stable.fast")

plot(pc_aid, main = "")
```

With a threshold of 0.01, the outcome is entirely seperated from the rest of variables. Therefore, we believe 0.01 is too strict and thus relax it to 0.05.

### alpha=0.05
```{r}
pc_aid <- pc(suff_stat, indepTest = gaussCItest, labels = colnames(causalAid), alpha = 0.05, skel.method = "stable.fast")
plot(pc_aid, main = "")
```

### alpha=0.12
```{r}
pc_aid <- pc(suff_stat, indepTest = gaussCItest, labels = colnames(causalAid), alpha = 0.12, skel.method = "stable.fast")
plot(pc_aid, main = "")
```

Comparing the resulted causal graph with our assumptions, we spot the following causal flow that we didn't identify before:

>
1. it's mainly ODA, instead of OOF, that contributes to other variables. For example, the graph shows that US_ODA has a direct effect on popolucation growth rate, which stimulates GDP growth. Rest_of_Work_ODA also contributes to population, which directly affects recipient's world trade. 
2. US_ODA has a direct effect on Rest_of_Work_ODA.
3. oda_gni directly affects recipient_trade_world.

As we relax the treshold from 0.01 to 0.12, there are a few changes we think might be of interests:

>
1. when threshold is 0.01, recipient_trade_world contributes to population. When threshold increases, it's polulation contributes to recipient_trade_world. Therefore, both directions worth exploring in our later sensitivity analysis.
2. when threshold increases to 0.12, polity2 is considered to contribute to population growth. 

It appears that the way variables affect the outcome is via population growth.

# Visualization

Before we construct the regression model, we would first want to visualize the association between U.S aid and other controlled variables in our model. The goal of visualization is to find out if the association is linear or not and if we should introduce the nonlinearity into our model.

### GDP growth rate vs. US foreign aid (Treatment vs. Outcome)

```{r}
ggplot(data = aid2007,aes(x = GDP_total_growth_rate,y = log(US_aid_total)))+
  geom_point()+
  geom_smooth()
```

According to the graph, the relatively flat slope suggests that we might not expect there is a statistical significant association between U.S aid and the GDP growth rate.

### Other variables vs. U.S aid

For all graphs below, blue lines are dervied from the actual data, providing insights on how a variable affects if one receives the treatment or not. The red lines are used to depict that relationship.

##### 1. Population growth rate vs. U.S aid

```{r}
ggplot(data = aid2007, aes(x = population_growth_rate, y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,3), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```

According to the graph above, we might incorporate population growth rate as an non-linear variable in our model. 

##### 2. Trade balance of recipient countries vs. U.S aid

```{r}
ggplot(data = aid2007, aes(x = log(recipient_trade_world), y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,1), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```

Since the trade balance of recipient countries is relative big number compared to the foreign aid, we want to use the natural log of the trade balance so that we are able to see numbers on the same scale; also, our analysis would not misled by the big numbers. In this graph, we can see that the natural log of trade balance of recipient countries is relatively linear; therefore, we would want to use linear association for this variable. 

##### 3. Politics score vs. U.S aid

```{r}
ggplot(data = aid2007, aes(x = polity2, y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,3), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```

In this graph, we can see that association between U.S aid and politics score is non-linear; therefore, this variable should also be non-linear in our model.

### Informed by causal discovery graph

Informed by rge causal discovery algorithm, we also explore the relationship between US_ODA and other variables. In the below section, we visualize the relationships that are suggested by the causal discovery algorithm.

#####  US_ODA as treatment to replace US_aid_total 

How GDP_total_growth_rate is affected by US_ODA and Rest_of_world_ODA?

```{r}
ggplot(data = causalAid, aes(x = US_ODA, y = GDP_total_growth_rate)) +
    geom_point(aes(color = Rest_of_world_ODA), size = 2) +
    geom_smooth(se = FALSE, color = "blue")+
    geom_smooth(formula = y~ns(x,3), method = "lm",
        se = FALSE, color = "red"
    )+
  coord_cartesian(xlim = c(0,1000))+
  scale_color_gradient(low = "yellow", high = "darkblue")
```

From the plot, we can tell `U.S. ODA` and `rest of world ODA` are correlated, which verifies the causal graph above.
We vaguely get a sense that both world ODA and U.S. ODA positively contribute to GDP total growth rate.

##### Does Rest_of_world_ODA_total affect the outcome?

```{r}
ggplot(data = causalAid, aes(x = Rest_of_world_aid_total, y = GDP_total_growth_rate)) +
    geom_point() +
    geom_smooth(se = FALSE, color = "blue")+
    geom_smooth(formula = y~ns(x,2), method = "lm",
        se = FALSE, color = "red"
    )
```

Earlier, we didn't see a causal flow from `rest of world aid` to the outcome, which is implausible from common sense. However, this graph suggests we are still justified to believe `rest of world aid` might open another causal graph .

##### Does polity2 interact with US_ODA?

```{r}
ggplot(data = causalAid, aes(x = US_ODA, y =polity2 )) +
    geom_point(aes(color = GDP_total_growth_rate), size = 2) +
  scale_color_gradient(low = "yellow", high = "darkblue")+
    geom_smooth(se = FALSE, color = "blue")+
  coord_cartesian(xlim = c(0,1000))
```

The colored scatter points don't seem to form a clear pattern. Therefore we don't assume an interaction between polity2 and US_ODA.



## Regression Model

### Regression Results and Interpretation

```{r}
mod<-lm(GDP_total_growth_rate~ US_aid_total, data = aid2007)
summary(mod)
confint(mod)
```


```{r}
mod1 <- lm(GDP_total_growth_rate~ ns(US_ODA,3) +recipient_trade_world+ns(polity2,3)+ns(population_growth_rate,3),data = aid2007)
summary(mod1)
confint(mod1)
```

According to our model, the coefficient of U.S aid is 5.963e-04, suggesting that U.S aid can generate positive economic impact on the recipients; however, the impact is relatively small and not significant in 2007. Also, we can see that the coefficients of U.S aid is not statistically significant after we incorporate all the controlled variables in our model. Therefore, we might suggest that there are indirect paths connecting the foreign aid and the GDP growth rate of recipient countries; and we might conclude that U.S aid can contribute to the GDP growth rate of recipients countries indirectly, but we still can not verify the vadility of the direct path or the direct impact of U.S aid and the GDP growth rate of recipient countries.


### Evaluation of regression model

```{r}
results <- data.frame(resid = resid(mod1), fitted = fitted(mod1))
        ggplot(results, aes(x = fitted, y = resid)) + 
          geom_point() + 
          geom_hline(yintercept = 0)
```

In the residual plot, we can see that the residuals are assigned relatively evenly across the x-axis; also, the spread is also relatively random. Therefore, our model might provide a fair and accurate analysis. 


# Sensivity Analysis

## Unmeasured Variable

```{r}
sensitivity_analysis <- function(.data, model_A, model_Y, assoc_A, assoc_Y) {
    n <- nrow(.data)

    # Obtain residuals with residuals()
    # Obtain residual variances with sigma()
    res_A <- residuals(model_A)
    res_var_A <- sigma(model_A)^2
    res_Y <- residuals(model_Y)
    res_var_Y <- sigma(model_Y)^2

    # Compute the mean and variance of U given A and Y
    mean_U_term1 <- (assoc_A/res_var_A)*res_A
    mean_U_term2 <- (((res_var_A - assoc_A^2)*assoc_Y)/(res_var_A*res_var_Y))*res_Y
    mean_U <- mean_U_term1 + mean_U_term2

    var_U_term1 <- (res_var_A - assoc_A^2)/(res_var_A*res_var_Y)
    var_U_term2 <- res_var_Y - assoc_Y^2 + ((assoc_A*assoc_Y)^2)/res_var_A
    var_U <- var_U_term1*var_U_term2

    # Simulate U and add it to the data
    U <- rnorm(n, mean = mean_U, sd = sqrt(var_U))
    .data$U <- U

    ########################################################################
    # The part below is the only part you need to change to implement
    # the sensitivity analysis in a new context.

    # Refit model to estimate the causal effect 
    updated_model <- lm(GDP_total_growth_rate ~US_aid_total +recipient_trade_world+ns(polity2,3)+ns(population_growth_rate,3)+U, data = .data)
    # The names of the coefficients and confidence interval output rows
    # are called "A" for the treatment variable A.
    # This will change in a new dataset.
    print(coefficients(updated_model))
    list(c(
        estimate = unname(coefficients(updated_model)["US_ODA"]), 
        ci_95_lower = confint(updated_model)["US_ODA",1],
        ci_95_upper = confint(updated_model)["US_ODA",2]
    ))
}


# Begin the sensitivity analysis

# Fit required models for the sensitivity analysis
mod_A <- lm(US_ODA ~ ns(polity2,3), data = aid2007)
mod_Y <- lm(GDP_total_growth_rate ~US_aid_total +recipient_trade_world+ns(polity2,3)+ns(population_growth_rate,3), data = aid2007)

# Set up degree of association between U and A and between U and Y
# The U->A associations have some constraints: we set up values 
# for the U->A associations that are at most equal to the
# standard deviation of the residuals from the model for A.
U_A_assocs <- seq(from = 0.01, to = sigma(mod_A), length.out = 10)
U_Y_assocs <- seq(from = -5, to = -0.5, by = 0.5)

# Form all combinations of the U->A and U->Y sensitivity parameters
sens_data <- expand.grid(U_A = U_A_assocs, U_Y = U_Y_assocs)

# Run sensitivity analysis
sens_data <- sens_data %>%
    group_by(U_A, U_Y) %>%
    mutate(sens = sensitivity_analysis(aid2007, mod_A, mod_Y, U_A, U_Y))
# Collect sensitivity analysis results in a data.frame
sens_data <- bind_cols(sens_data[,1:2], bind_rows(sens_data$sens))


# Plot results
prepender <- function(string, prefix = "U -> Y strength:") paste(prefix, string)

ggplot(sens_data, aes(x = U_A, y = estimate)) +
    geom_ribbon(aes(ymin = ci_95_lower, ymax = ci_95_upper), fill = "grey70") +
    geom_line() +
    geom_hline(aes(yintercept = coefficients(mod_Y)["US_ODA"]), color = "blue", lty = "dashed") +
    geom_hline(aes(yintercept = 0), color = "black") +
    facet_wrap(~U_Y, labeller = as_labeller(prepender)) +
    labs(x = "Strength of U -> A association", y = "ACE and 95% CI")
```

## Different Year (2012)

##### 1. Population growth rate vs. U.S aid

```{r}
p1<- ggplot(data = aid2012, aes(x = population_growth_rate, y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,2), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```


##### 2. Trade balance of recipient countries vs. U.S aid

```{r}
p2<- ggplot(data = aid2012, aes(x = log(recipient_trade_world), y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,1), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```

##### 3. Politics score vs. U.S aid

```{r}
p3<- ggplot(data = aid2012, aes(x = polity2, y = log(US_aid_total))) +
  geom_point() +
  geom_smooth(se = FALSE, color = "blue")+ 
  geom_smooth(formula = y~ns(x,3), method = "lm",
    method.args = list(family="binomial"),
    se = FALSE, color = "red" )
```

```{r}
library("gridExtra")
grid.arrange(p1,p2,p3)
```



```{r}
mod2 <- lm(GDP_total_growth_rate~ US_aid_total +recipient_trade_world+ns(polity2,3)+ns(population_growth_rate,2),data = aid2007)
summary(mod2)
confint(mod2)
```
```{r}
mod3 <- lm(GDP_total_growth_rate~ US_aid_total ,data = aid2012)
summary(mod3)
confint(mod3)
```

Evaluation of regression model

```{r}
results <- data.frame(resid = resid(mod2), fitted = fitted(mod2))
        ggplot(results, aes(x = fitted, y = resid)) + 
          geom_point() + 
          geom_hline(yintercept = 0)
```

The regression using data from 2010 gave us the same results: U.S aid can generate insignificant positive economic impact on the recipients. The coefficient of U.S aid is not significant in the model that included all controls; therefore, we can still suggest there are indirect paths from U.S aid to the GDP growth rate, but we can not conclude that there is direct impact on the economics of the recipient countries.

## Another Measurement of Economic growth

```{r}
mod4 <- lm(GDP_per_growth_rate ~ US_aid_total +recipient_trade_world+ns(polity2,3)+ns(population_growth_rate,3),data = aid2007)
summary(mod4)
confint(mod4)
```

We also switch to another common estimator of economic growth: GDP per capita growth rate. The coefficient of U.S aid is still not significant and the magnitude remains small; therefore, our results are consistent with the previous regression model. 


# Limitations 

## Limited Time line
In our model, we only used data in a particular year, which might not be persuasive or representative enough for us to make strong conclusion on the impact of U.S aid. For the future study, we might want to consider using a panel dataset and a time series model, such as the mixed effect model; then we might be able to generalize our conclusion on the impact of U.S aid. 

## Other important variables
We also know that there are various type of foreign aid, ODA and OOF. Also, within ODA and OOF, there are various type of aids as well. Some are goverment grants, and others might be loans. Since there are different forms of foreign aids and their characteristics might generate different impact on the economics of the recipient countries. Therefore, we might also want to examine the impact of various types of foreign aids, which can lead us to an alternative answer.

## Causal Discovery and Regression
We used causal discovery to explore various forms of causal paths and graphs; however, we did not build our regression based on different conditional sets generated through causal discovery. Therefore, for future study, we can have different sets of conditional variables according to causal discovery and build regression models for each of those. 


# Reference

1. Official development assistance (ODA) - Net ODA - OECD Data. (n.d.). Retrieved October 18, 2020, from https://data.oecd.org/oda/net-oda.htm


















